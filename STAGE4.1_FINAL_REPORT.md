# STAGE 4.1 - –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–Å–¢

**–î–∞—Ç–∞:** 2024-11-03  
**–í–µ—Ä—Å–∏—è:** 4.1.0+2  
**Build:** v4.1-real-applied  
**–í–µ—Ç–∫–∞:** prod/stage4.1-real-fix

---

## ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ù–´–ï –§–ê–ô–õ–´

### 1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —Å–µ—Å—Å–∏—è
- **lib/core/auth_gate.dart** ‚Äî —Å–æ–∑–¥–∞–Ω —ç–∫—Ä–∞–Ω-–≤–æ—Ä–æ—Ç–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π authStateChanges, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º AUTH_SCREEN_SHOWN/ROLE_SELECTION_SHOWN/HOME_LOADED
- **lib/core/app_router_minimal_working.dart** ‚Äî –∏–∑–º–µ–Ω–µ–Ω initialLocation –Ω–∞ /auth-gate, –¥–æ–±–∞–≤–ª–µ–Ω –º–∞—Ä—à—Ä—É—Ç /auth-gate
- **lib/utils/debug_log.dart** ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç dev.log –∏ print –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ release

### 2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- **lib/screens/auth/register_screen_enhanced.dart** ‚Äî —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —ç–∫—Ä–∞–Ω —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ firstName, lastName, role; username —Å live-–ø—Ä–æ–≤–µ—Ä–∫–æ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ (debounce 400ms)

### 3. –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
- **lib/screens/home/home_screen_simple.dart** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HOME_LOADED; –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∫–ª–∏–∫–∏: –∞–≤–∞—Ç–∞—Ä ‚Üí –ø—Ä–æ—Ñ–∏–ª—å, —à–µ—Å—Ç–µ—Ä–µ–Ω–∫–∞ ‚Üí settings, –∫–Ω–æ–ø–∫–∏ ‚Üí –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–æ—É—Ç—ã; –æ–±–Ω–æ–≤–ª–µ–Ω —Ñ–æ—Ä–º–∞—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏ (username –∫—Ä—É–ø–Ω–æ, FIO –º–µ–Ω—å—à–µ; –µ—Å–ª–∏ –Ω–µ—Ç username ‚Äî —Ç–æ–ª—å–∫–æ FIO –∫—Ä—É–ø–Ω–æ)

### 4. –ù–∞–≤–∏–≥–∞—Ü–∏—è
- **lib/screens/main_navigation_screen.dart** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω PopScope —Å –¥–∏–∞–ª–æ–≥–æ–º –≤—ã—Ö–æ–¥–∞ –Ω–∞ root-—ç–∫—Ä–∞–Ω–∞—Ö

### 5. –ß–∞—Ç—ã
- **firestore.rules** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è isParticipant(); –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è messages —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —á–µ—Ä–µ–∑ isParticipant()
- **lib/services/optimized_chat_service.dart** ‚Äî –∑–∞–º–µ–Ω–µ–Ω—ã members –Ω–∞ participants, lastMessageAt –Ω–∞ updatedAt
- **lib/screens/chat/chat_list_screen_improved.dart** ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å: participants –≤–º–µ—Å—Ç–æ members, updatedAt –≤–º–µ—Å—Ç–æ lastMessageAt; –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ CHATS_LOADED

### 6. –õ–µ–Ω—Ç–∞ –∏ –∏–¥–µ–∏
- **lib/screens/feed/feed_screen_improved.dart** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ FEED_LOADED
- **lib/screens/ideas/ideas_screen.dart** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ IDEAS_LOADED

### 7. –ó–∞—è–≤–∫–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- **lib/screens/requests/requests_screen_improved.dart** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ REQUESTS_LOADED
- **lib/screens/settings/settings_screen.dart** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –º–µ—Ç–∫–∞ –≤–µ—Ä—Å–∏–∏ –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞ "Build: v4.1-real-applied"; –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SETTINGS_OPENED

### 8. –í–µ—Ä—Å–∏—è –∏ —Å–±–æ—Ä–∫–∞
- **pubspec.yaml** ‚Äî version: 4.1.0+2
- **lib/core/build_version.dart** ‚Äî —Å–æ–∑–¥–∞–Ω: const String BUILD_VERSION = 'v4.1-real-applied'
- **lib/screens/auth/login_screen_modern.dart** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ AUTH_SCREEN_SHOWN
- **lib/screens/auth/role_selection_screen.dart** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ROLE_SELECTION_SHOWN

### 9. Firestore Rules/Indexes
- **firestore.rules** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è isParticipant(), –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è chats/messages
- **firestore.indexes.json** ‚Äî –∏–Ω–¥–µ–∫—Å –¥–ª—è chats (participants ARRAY, updatedAt DESC) —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- **–î–µ–ø–ª–æ–π:** ‚úÖ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ

---

## üì¶ –í–ï–†–°–ò–ò –°–ë–û–†–û–ö

- **APK:** build/app/outputs/flutter-apk/app-release.apk
  - –†–∞–∑–º–µ—Ä: 75.58 MB
  - versionName: 4.1.0
  - versionCode: 2
  - SHA1: 4389F92D5DFB41CED1D5A905D09AD5BF19278415

- **AAB:** build/app/outputs/bundle/release/app-release.aab
  - –†–∞–∑–º–µ—Ä: 63.45 MB

---

## ‚úÖ –£–°–¢–ê–ù–û–í–ö–ê –ù–ê –£–°–¢–†–û–ô–°–¢–í–û

- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
- **–ö–æ–º–∞–Ω–¥–∞:** `adb install -r build/app/outputs/flutter-apk/app-release.apk`
- **–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:** 34HDU20228002261

---

## üìä –ê–í–¢–û–°–ú–û–ö-–¢–ï–°–¢

**–õ–æ–≥:** logs/stage4.1_smoke_log.txt

**–û–∂–∏–¥–∞–µ–º—ã–µ –º–∞—Ä–∫–µ—Ä—ã:**
- ‚úÖ AUTH_SCREEN_SHOWN ‚Äî –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —ç–∫—Ä–∞–Ω–∞ –ª–æ–≥–∏–Ω–∞
- ‚úÖ ROLE_SELECTION_SHOWN ‚Äî –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ —Ä–æ–ª–∏
- ‚úÖ HOME_LOADED ‚Äî –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
- ‚úÖ FEED_LOADED ‚Äî –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ª–µ–Ω—Ç—ã
- ‚úÖ IDEAS_LOADED ‚Äî –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–¥–µ–π
- ‚úÖ REQUESTS_LOADED ‚Äî –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞—è–≤–æ–∫
- ‚úÖ CHATS_LOADED ‚Äî –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–æ–≤
- ‚úÖ SETTINGS_OPENED ‚Äî –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ú–∞—Ä–∫–µ—Ä—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `debugLog()`, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `dev.log()` –∏ `print()`. –í release-—Å–±–æ—Ä–∫–µ –º–∞—Ä–∫–µ—Ä—ã –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ logcat —Å —Ñ–∏–ª—å—Ç—Ä–æ–º `APP:*`.

---

## ‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ú–ï–¢–ö–ò –í–ï–†–°–ò–ò

**–≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫:** –í–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–µ–∫—Å—Ç "Build: v4.1-real-applied" (–º–∞–ª–µ–Ω—å–∫–∏–π —Å–µ—Ä—ã–π —Ç–µ–∫—Å—Ç).

---

## üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

1. ‚úÖ **Auth Gate:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ —á–µ—Ä–µ–∑ authStateChanges, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
2. ‚úÖ **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:** –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ firstName, lastName, role; username —Å live-–ø—Ä–æ–≤–µ—Ä–∫–æ–π
3. ‚úÖ **–ì–ª–∞–≤–Ω–∞—è:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –∫–ª–∏–∫–∏, –æ–±–Ω–æ–≤–ª–µ–Ω —Ñ–æ—Ä–º–∞—Ç –∏–º–µ–Ω–∏
4. ‚úÖ **Back Button:** –î–∏–∞–ª–æ–≥ –≤—ã—Ö–æ–¥–∞ –Ω–∞ root-—ç–∫—Ä–∞–Ω–∞—Ö
5. ‚úÖ **–ß–∞—Ç—ã:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –∏ –∑–∞–ø—Ä–æ—Å—ã (participants –≤–º–µ—Å—Ç–æ members)
6. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ —ç–∫—Ä–∞–Ω—ã –ª–æ–≥–∏—Ä—É—é—Ç –º–∞—Ä–∫–µ—Ä—ã —á–µ—Ä–µ–∑ debugLog
7. ‚úÖ **–í–µ—Ä—Å–∏—è:** –ú–µ—Ç–∫–∞ –≤–µ—Ä—Å–∏–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö

---

## üìù –ö–û–ú–ú–ò–¢–´

```
git checkout -B prod/stage4.1-real-fix
git add .
git commit -m "stage4.1: real fixes applied"
```

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–°–ï –ó–ê–î–ê–ß–ò –í–´–ü–û–õ–ù–ï–ù–´

