rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Функции для проверки авторизации
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }
    
    // Запрет саморевью
    function isNotSelfReview() {
      return request.resource.data.authorId != request.resource.data.specialistId;
    }
    
    function isParticipant(chatId) {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/chats/$(chatId)) &&
        (request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
    }
    
    // Users
    match /users/{uid} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && uid == request.auth.uid;
      allow update: if isSignedIn() && uid == request.auth.uid;
      allow delete: if isOwner(uid);
      
      match /saved_ideas/{docId} {
        allow read, write: if isOwner(uid);
      }
      
      match /saved_filters/{filterId} {
        allow read, write: if isSignedIn() && uid == request.auth.uid;
      }
    }

    // Specialists (доп. профиль)
    match /specialists/{uid} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && uid == request.auth.uid;
      allow delete: if isOwner(uid);
      
      match /cases/{caseId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isOwner(uid);
      }
    }

    // Followers / Follows
    match /follows/{doc} {
      allow read: if isSignedIn();
      allow create, delete: if isSignedIn();
      allow update: if false;
    }

    // Posts / Reels
    match /posts/{id} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
      
      match /post_likes/{likeId} {
        allow read: if isSignedIn();
        allow create, delete: if isSignedIn();
      }
      
      match /post_comments/{commentId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update, delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
      }
    }
    
    match /reels/{id} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    // Stories
    match /stories/{id} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    // Requests + Responses
    match /requests/{requestId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.createdBy == request.auth.uid;

      match /responses/{respId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && request.resource.data.specialistId == request.auth.uid;
        allow update, delete: if false;
      }
    }

    // Notifications
    match /notifications/{id} {
      allow read, write: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    // Saved Filters
    match /users/{uid}/saved_filters/{filterId} {
      allow read, write: if isSignedIn() && uid == request.auth.uid;
    }

    // Chats
    match /chats/{chatId} {
      allow read, write: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participants;

      match /messages/{messageId} {
        allow read: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        allow create: if isSignedIn() && request.resource.data.senderId == request.auth.uid
            && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        allow update, delete: if false;
      }
    }

    // Reviews
    match /reviews/{id} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() 
                && request.resource.data.authorId == request.auth.uid
                && isNotSelfReview();
      allow update, delete: if false;
    }
    
    // Ideas
    match /ideas/{ideaId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }
    
    // Bookings
    match /bookings/{bookingId} {
      allow read, write: if isSignedIn();
    }
    
    // Events
    match /events/{eventId} {
      allow read, write: if isSignedIn();
    }
    
    // Categories
    match /categories/{categoryId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.token.admin == true;
    }
    
    // Support tickets
    match /support_tickets/{ticketId} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow delete: if false;
    }
    
    // Analytics events
    match /events_profile_views/{eventId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.viewerId == request.auth.uid;
      allow update, delete: if false;
    }

    match /events_post_engagement/{eventId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.actorId == request.auth.uid;
      allow update, delete: if false;
    }

    match /events_follow/{eventId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.followerId == request.auth.uid;
      allow update, delete: if false;
    }

    match /events_requests/{eventId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && (
        request.resource.data.customerId == request.auth.uid ||
        (request.resource.data.status == 'completed' && 
         request.resource.data.specId == request.auth.uid)
      );
      allow update, delete: if false;
    }

    // Specialist stats
    match /specialist_stats/{specId} {
      allow read: if isSignedIn();
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    match /specialist_scores/{specId} {
      allow read: if isSignedIn();
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    // Остальное — запрещено
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
