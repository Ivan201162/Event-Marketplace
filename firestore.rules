rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Функции для проверки авторизации
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }
    
    // Запрет саморевью
    function isNotSelfReview() {
      return request.resource.data.authorId != request.resource.data.specialistId;
    }
    
    // isParticipant удалена - используется напрямую в правилах
    
    // Users
    match /users/{uid} {
      allow read: if isSignedIn();
      allow create: if isOwner(uid);
      allow update: if isOwner(uid);
      allow delete: if isOwner(uid);
      
      match /saved_ideas/{docId} {
        allow read, write: if isOwner(uid);
      }
      
      match /saved_filters/{filterId} {
        allow read, write: if isSignedIn() && uid == request.auth.uid;
      }
      
      match /prices/{priceId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isSignedIn() && request.auth.uid == uid;
      }
    }
    
    // Calendar (старая структура - оставляем для совместимости)
    match /calendar/{specialistId}/{monthId}/{dayId} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && (
        request.resource.data.clientId == request.auth.uid // клиент создаёт pending
        || request.auth.uid == specialistId // специалист меняет статус
      );
      allow delete: if false;
    }
    
    // BOOKINGS (Stage 7+8)
    match /bookings/{bookingId} {
      allow read: if isSignedIn();
      
      // создаёт только клиент за себя
      allow create: if isSignedIn()
        && request.resource.data.clientId == request.auth.uid
        && request.resource.data.specialistId is string
        && request.resource.data.status == "pending";
      
      // обновлять статус может:
      // - специалист для своих бронирований (accepted/declined)
      // - клиент может отменить свою (cancelled)
      allow update: if isSignedIn() && (
        // специалист меняет статус своей брони
        (get(/databases/$(database)/documents/bookings/$(bookingId)).data.specialistId == request.auth.uid
          && request.resource.data.status in ["accepted","declined","pending"])
        ||
        // клиент отменяет свою бронь
        (get(/databases/$(database)/documents/bookings/$(bookingId)).data.clientId == request.auth.uid
          && request.resource.data.status in ["cancelled","pending"])
      );
      
      allow delete: if false;
    }
    
    // SPECIALIST CALENDAR (Stage 7+8)
    match /specialist_calendar/{specialistId}/days/{dayId} {
      // читать может любой авторизованный (клиенту не раскрываем личности — тут их нет)
      allow read: if isSignedIn();
      // обновлять может только сам специалист (через клиентскую транзакцию)
      allow update, create: if isSignedIn() && request.auth.uid == specialistId;
      allow delete: if false;
    }
    
    // Calendars (старая структура - оставляем для совместимости)
    match /calendars/{specialistId}/days/{dayId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == specialistId;
    }

    // Specialists (доп. профиль)
    match /specialists/{uid} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && uid == request.auth.uid;
      allow delete: if isOwner(uid);
      
      match /cases/{caseId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isOwner(uid);
      }
    }

    // Followers / Follows
    match /follows/{doc} {
      allow read: if isSignedIn();
      allow create, delete: if isSignedIn();
      allow update: if false;
    }

    // Posts
    match /posts/{id} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && request.auth.uid == resource.data.authorId;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.authorId;
    }
    
    // Reels
    match /reels/{id} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.authorId;
    }

    // Stories
    match /stories/{id} {
      allow read: if isSignedIn(); // только авторизованные видят сторисы
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.authorId;
    }

    // Requests + Responses
    match /requests/{requestId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.createdBy;

      match /responses/{respId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && request.resource.data.specialistId == request.auth.uid;
        allow update, delete: if false;
      }
    }

    // Notifications
    match /notifications/{id} {
      allow read, write: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }

    // Saved Filters
    match /users/{uid}/saved_filters/{filterId} {
      allow read, write: if isSignedIn() && uid == request.auth.uid;
    }

    // Функция проверки участия в чате
    function isChatParticipant(chatId) {
      return exists(/databases/$(database)/documents/chats/$(chatId)) &&
             get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
    }

    // Chats
    match /chats/{chatId} {
      allow read: if isSignedIn() && isChatParticipant(chatId);
      allow create: if false; // Создание через Cloud Function
      allow update: if false; // Обновление через Cloud Function

      match /messages/{messageId} {
        allow read: if isSignedIn() && isChatParticipant(chatId);
        allow create: if isSignedIn() && isChatParticipant(chatId) && 
            request.resource.data.senderId == request.auth.uid;
        // Редактировать/удалять только своё сообщение
        allow update: if isSignedIn() && isChatParticipant(chatId) &&
            get(/databases/$(database)/documents/chats/$(chatId)/messages/$(messageId)).data.senderId == request.auth.uid;
        allow delete: if false; // Удаление через update (deleted=true)

        match /messageReactions/{userId} {
          allow read: if isSignedIn() && isChatParticipant(chatId);
          allow create, update, delete: if isSignedIn() && isChatParticipant(chatId) && 
              request.auth.uid == userId;
        }
      }
    }

    // Reviews 2.0 - только после confirmed booking
    // Проверка confirmed booking делается на клиенте через ReviewServiceV2
    match /reviews/{id} {
      allow read: if isSignedIn();
      
      // Создать отзыв - базовая валидация (полная проверка на клиенте)
      allow create: if isSignedIn() 
        && request.resource.data.authorId == request.auth.uid
        && request.resource.data.specialistId is string
        && request.resource.data.rating is int
        && request.resource.data.rating >= 1
        && request.resource.data.rating <= 5
        && request.resource.data.text is string
        && request.resource.data.text.size() >= 5
        && isNotSelfReview();
      
      // Обновить может только автор (для редактирования) или специалист (для ответа)
      allow update: if isSignedIn() && (
        (resource.data.authorId == request.auth.uid && 
         request.resource.data.authorId == resource.data.authorId &&
         request.resource.data.specialistId == resource.data.specialistId) ||
        (resource.data.specialistId == request.auth.uid && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reply', 'updatedAt']))
      );
      
      allow delete: if false; // Отзывы не удаляются
    }
    
    // Ideas
    match /ideas/{ideaId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.authorId;
    }
    
    // Comments (v7.2: comments/{contentId}/comments/{commentId})
    match /comments/{contentId}/comments/{commentId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid
        && request.resource.data.text is string && request.resource.data.text.size() > 0
        && request.resource.data.contentType is string
        && request.resource.data.contentId == contentId;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.authorId;
    }
    
    // Specialist Pricing
    match /specialist_pricing/{specialistId} {
      allow read: if isSignedIn();
      
      match /base/{priceId} {
        allow read: if isSignedIn();
        allow create, update: if isSignedIn() && request.auth.uid == specialistId;
        // При удалении роли - помечаем hidden=true, не удаляем
        allow delete: if false;
      }
      
      match /special_dates/{dateId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isSignedIn() && request.auth.uid == specialistId;
      }
    }
    
    // Specialist Calendar (v2 - с pending/confirmed статусами)
    match /specialist_calendar/{specialistId}/days/{dayId} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && request.auth.uid == specialistId
        && (request.resource.data.keys().hasAny(['pendingCount', 'acceptedBookingId']) ||
            request.resource.data.diff(resource.data).affectedKeys().hasAny(['pendingCount', 'acceptedBookingId']));
      allow delete: if false; // Удаление запрещено
    }
    
    // Bookings (v2 - с autoAccept опцией)
    match /bookings/{bookingId} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.clientId ||
        request.auth.uid == resource.data.specialistId
      );
      allow create: if isSignedIn() && 
        request.resource.data.clientId == request.auth.uid
        && request.resource.data.status in ['pending', 'accepted']; // autoAccept может сразу установить accepted
      // Специалист может подтвердить/отклонить (accepted/declined)
      // Клиент может отменить (cancelled)
      allow update: if isSignedIn() && (
        (request.auth.uid == resource.data.specialistId && 
         request.resource.data.status in ['accepted', 'declined', 'pending']) ||
        (request.auth.uid == resource.data.clientId && 
         request.resource.data.status in ['cancelled', 'pending'])
      );
      allow delete: if false;
    }
    
    // Events
    match /events/{eventId} {
      allow read, write: if isSignedIn();
    }
    
    // Categories
    match /categories/{categoryId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.token.admin == true;
    }
    
    // Support tickets
    match /support_tickets/{ticketId} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow delete: if false;
    }
    
    // Analytics events
    match /events_profile_views/{eventId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.viewerId == request.auth.uid;
      allow update, delete: if false;
    }

    match /events_post_engagement/{eventId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.actorId == request.auth.uid;
      allow update, delete: if false;
    }

    match /events_follow/{eventId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.followerId == request.auth.uid;
      allow update, delete: if false;
    }

    match /events_requests/{eventId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && (
        request.resource.data.customerId == request.auth.uid ||
        (request.resource.data.status == 'completed' && 
         request.resource.data.specId == request.auth.uid)
      );
      allow update, delete: if false;
    }

    // Specialist stats
    match /specialist_stats/{specId} {
      allow read: if isSignedIn();
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    match /specialist_scores/{specId} {
      allow read: if isSignedIn();
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    // Likes
    match /likes/{userId}/{contentType}/{contentId} {
      allow read: if isSignedIn();
      allow create, delete: if isSignedIn() && request.auth.uid == userId;
      allow update: if false;
    }
    
    // Saves (bookmarks)
    match /saves/{userId}/{contentType}/{contentId} {
      allow read: if isSignedIn();
      allow create, delete: if isSignedIn() && request.auth.uid == userId;
      allow update: if false;
    }
    
    // User Following/Followers (subcollections)
    match /users/{userId}/following/{targetId} {
      allow read: if isSignedIn();
      allow create, delete: if isSignedIn() && request.auth.uid == userId;
      allow update: if false;
    }
    
    match /users/{userId}/followers/{targetId} {
      allow read: if isSignedIn();
      allow create, delete: if isSignedIn();
      allow update: if false;
    }

    // Остальное — запрещено
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
