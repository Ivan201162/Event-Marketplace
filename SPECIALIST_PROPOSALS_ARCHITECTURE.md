# Архитектура системы предложений специалистов

## Диаграмма компонентов

```
┌─────────────────────────────────────────────────────────────────┐
│                        UI Layer                                 │
├─────────────────────────────────────────────────────────────────┤
│  ProposalsScreen          │  OrganizerProposalsScreen          │
│  (Заказчик)              │  (Организатор)                     │
│  ┌─────────────────────┐  │  ┌─────────────────────────────┐   │
│  │ • Просмотр          │  │  │ • Управление                │   │
│  │ • Принятие/Отклонение│  │  │ • Статистика                │   │
│  │ • Бронирование      │  │  │ • Редактирование            │   │
│  └─────────────────────┘  │  └─────────────────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│  SpecialistSelectionScreen │  NotificationsScreen              │
│  ┌─────────────────────┐  │  ┌─────────────────────────────┐   │
│  │ • Выбор специалистов│  │  │ • Просмотр уведомлений      │   │
│  │ • Создание предложения│  │  │ • Управление               │   │
│  └─────────────────────┘  │  └─────────────────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│  ProposeSpecialistsButton  │  NotificationBadge                │
│  (В чате)                 │  (Счетчик)                        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      Service Layer                              │
├─────────────────────────────────────────────────────────────────┤
│  ProposalService                                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ • createProposal()                                      │   │
│  │ • acceptProposal()                                      │   │
│  │ • rejectProposal()                                      │   │
│  │ • getCustomerProposals()                                │   │
│  │ • getOrganizerProposals()                               │   │
│  │ • getProposalsByStatus()                                │   │
│  │ • getProposalStats()                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│  NotificationService                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ • sendProposalNotification()                            │   │
│  │ • sendProposalAcceptedNotification()                    │   │
│  │ • sendProposalRejectedNotification()                    │   │
│  │ • getUserNotifications()                                │   │
│  │ • markNotificationAsRead()                              │   │
│  │ • getUnreadNotificationCount()                          │   │
│  └─────────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│  SpecialistService                                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ • getSpecialist()                                       │   │
│  │ • getAllSpecialists()                                   │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      Model Layer                                │
├─────────────────────────────────────────────────────────────────┤
│  SpecialistProposal                                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ • id: String                                            │   │
│  │ • organizerId: String                                   │   │
│  │ • customerId: String                                    │   │
│  │ • eventId: String                                       │   │
│  │ • specialistIds: List<String>                           │   │
│  │ • status: String                                        │   │
│  │ • createdAt: DateTime                                   │   │
│  │ • updatedAt: DateTime?                                  │   │
│  │ • message: String?                                      │   │
│  │ • metadata: Map<String, dynamic>?                       │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      Data Layer                                 │
├─────────────────────────────────────────────────────────────────┤
│  Firestore Collections                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ specialist_proposals                                    │   │
│  │ ├── proposalId                                          │   │
│  │ ├── organizerId                                         │   │
│  │ ├── customerId                                          │   │
│  │ ├── eventId                                             │   │
│  │ ├── specialistIds                                       │   │
│  │ ├── status                                              │   │
│  │ ├── createdAt                                           │   │
│  │ ├── updatedAt                                           │   │
│  │ ├── message                                             │   │
│  │ └── metadata                                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ notifications                                           │   │
│  │ ├── title                                               │   │
│  │ ├── body                                                │   │
│  │ ├── data                                                │   │
│  │ ├── fcmToken                                            │   │
│  │ ├── createdAt                                           │   │
│  │ ├── isRead                                              │   │
│  │ └── readAt                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## Поток данных

### 1. Создание предложения
```
Организатор → ProposeSpecialistsButton → SpecialistSelectionScreen 
→ ProposalService.createProposal() → Firestore → NotificationService 
→ Уведомление заказчику
```

### 2. Принятие предложения
```
Заказчик → ProposalsScreen → ProposalService.acceptProposal() 
→ Firestore → NotificationService → Уведомление организатору
```

### 3. Бронирование специалистов
```
Заказчик → ProposalsScreen → Кнопка "Забронировать" 
→ Экран бронирования с предвыбранными специалистами
```

## Интеграция с существующими компонентами

### Чат
- `ProposeSpecialistsButton` добавляется в чат между организатором и заказчиком
- Интеграция с существующей системой сообщений

### Бронирование
- Принятые предложения передают список специалистов в систему бронирования
- Предвыбор специалистов из предложения

### Уведомления
- Интеграция с Firebase Cloud Messaging
- Сохранение уведомлений в Firestore
- Отображение в приложении через `NotificationBadge`

## Безопасность и валидация

### Уровень сервиса
- Проверка авторизации пользователя
- Валидация входных данных
- Обработка ошибок

### Уровень UI
- Валидация выбора специалистов
- Проверка прав доступа
- Обратная связь пользователю

## Производительность

### Оптимизации
- Использование StreamBuilder для реального времени
- Ленивая загрузка специалистов
- Кэширование данных в Firestore
- Пагинация для больших списков

### Мониторинг
- Логирование ошибок
- Отслеживание производительности
- Аналитика использования
