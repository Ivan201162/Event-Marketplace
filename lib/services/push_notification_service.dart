import 'dart:async';
import 'package:firebase_messaging/firebase_messaging.dart';
import 'package:flutter/foundation.dart';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';

/// –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
class PushNotificationService {
  static final FirebaseMessaging _messaging = FirebaseMessaging.instance;
  static final FlutterLocalNotificationsPlugin _localNotifications =
      FlutterLocalNotificationsPlugin();

  static bool _isInitialized = false;

  /// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  static Future<void> initialize() async {
    if (_isInitialized) return;

    try {
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
      final settings = await _messaging.requestPermission(
        alert: true,
        announcement: false,
        badge: true,
        carPlay: false,
        criticalAlert: false,
        provisional: false,
        sound: true,
      );

      debugPrint(
          '‚úÖ Push notification permission status: ${settings.authorizationStatus}');

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      await _initializeLocalNotifications();

      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
      _setupMessageHandlers();

      _isInitialized = true;
      debugPrint('‚úÖ Push notification service initialized successfully');
    } catch (e) {
      debugPrint('‚ùå Error initializing push notification service: $e');
      rethrow;
    }
  }

  /// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  static Future<void> _initializeLocalNotifications() async {
    const androidSettings =
        AndroidInitializationSettings('@mipmap/ic_launcher');
    const iosSettings = DarwinInitializationSettings(
      requestAlertPermission: true,
      requestBadgePermission: true,
      requestSoundPermission: true,
    );

    const initSettings = InitializationSettings(
      android: androidSettings,
      iOS: iosSettings,
    );

    await _localNotifications.initialize(
      initSettings,
      onDidReceiveNotificationResponse: _onNotificationTapped,
    );

    // –°–æ–∑–¥–∞–µ–º –∫–∞–Ω–∞–ª –¥–ª—è Android
    const androidChannel = AndroidNotificationChannel(
      'chat_messages',
      'Chat Messages',
      description: 'Notifications for new chat messages',
      importance: Importance.high,
      playSound: true,
    );

    await _localNotifications
        .resolvePlatformSpecificImplementation<
            AndroidFlutterLocalNotificationsPlugin>()
        ?.createNotificationChannel(androidChannel);
  }

  /// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
  static void _setupMessageHandlers() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ foreground
    FirebaseMessaging.onMessage.listen(_handleForegroundMessage);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    FirebaseMessaging.onMessageOpenedApp.listen(_handleNotificationTap);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ background
    FirebaseMessaging.onBackgroundMessage(_handleBackgroundMessage);
  }

  /// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ foreground
  static Future<void> _handleForegroundMessage(RemoteMessage message) async {
    debugPrint('üì± Received foreground message: ${message.messageId}');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    await _showLocalNotification(message);
  }

  /// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  static void _handleNotificationTap(RemoteMessage message) {
    debugPrint('üì± Notification tapped: ${message.messageId}');

    // TODO: Navigate to specific chat
    final chatId = message.data['chatId'];
    if (chatId != null) {
      // Navigate to chat screen
      debugPrint('üì± Navigating to chat: $chatId');
    }
  }

  /// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ background
  static Future<void> _handleBackgroundMessage(RemoteMessage message) async {
    debugPrint('üì± Received background message: ${message.messageId}');

    // –í background –º—ã –Ω–µ –º–æ–∂–µ–º –ø–æ–∫–∞–∑–∞—Ç—å UI, —Ç–æ–ª—å–∫–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É
  }

  /// –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  static Future<void> _showLocalNotification(RemoteMessage message) async {
    final notification = message.notification;
    if (notification == null) return;

    final androidDetails = AndroidNotificationDetails(
      'chat_messages',
      'Chat Messages',
      channelDescription: 'Notifications for new chat messages',
      importance: Importance.high,
      priority: Priority.high,
      showWhen: true,
      icon: '@mipmap/ic_launcher',
    );

    const iosDetails = DarwinNotificationDetails(
      presentAlert: true,
      presentBadge: true,
      presentSound: true,
    );

    final details = NotificationDetails(
      android: androidDetails,
      iOS: iosDetails,
    );

    await _localNotifications.show(
      message.hashCode,
      notification.title,
      notification.body,
      details,
      payload: message.data.toString(),
    );
  }

  /// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  static void _onNotificationTapped(NotificationResponse response) {
    debugPrint('üì± Local notification tapped: ${response.payload}');

    // TODO: Parse payload and navigate to specific chat
    if (response.payload != null) {
      // Parse payload and navigate
    }
  }

  /// –ü–æ–ª—É—á–∏—Ç—å FCM —Ç–æ–∫–µ–Ω
  static Future<String?> getToken() async {
    try {
      final token = await _messaging.getToken();
      debugPrint('üì± FCM Token: $token');
      return token;
    } catch (e) {
      debugPrint('‚ùå Error getting FCM token: $e');
      return null;
    }
  }

  /// –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ç–æ–ø–∏–∫
  static Future<void> subscribeToTopic(String topic) async {
    try {
      await _messaging.subscribeToTopic(topic);
      debugPrint('‚úÖ Subscribed to topic: $topic');
    } catch (e) {
      debugPrint('‚ùå Error subscribing to topic $topic: $e');
    }
  }

  /// –û—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç —Ç–æ–ø–∏–∫–∞
  static Future<void> unsubscribeFromTopic(String topic) async {
    try {
      await _messaging.unsubscribeFromTopic(topic);
      debugPrint('‚úÖ Unsubscribed from topic: $topic');
    } catch (e) {
      debugPrint('‚ùå Error unsubscribing from topic $topic: $e');
    }
  }

  /// –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
  static Future<void> sendChatNotification({
    required String chatId,
    required String senderName,
    required String messageContent,
    required String receiverToken,
  }) async {
    try {
      // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ Cloud Functions
      // –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π API, –∞ –Ω–µ –∏–∑ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      debugPrint(
          'üì± Would send notification to $receiverToken: $messageContent');
    } catch (e) {
      debugPrint('‚ùå Error sending chat notification: $e');
    }
  }

  /// –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  static Future<void> clearAllNotifications() async {
    try {
      await _localNotifications.cancelAll();
      debugPrint('‚úÖ All notifications cleared');
    } catch (e) {
      debugPrint('‚ùå Error clearing notifications: $e');
    }
  }

  /// –û—á–∏—Å—Ç–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞
  static Future<void> clearChatNotifications(String chatId) async {
    try {
      // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å ID —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞
      await _localNotifications.cancel(chatId.hashCode);
      debugPrint('‚úÖ Notifications cleared for chat: $chatId');
    } catch (e) {
      debugPrint('‚ùå Error clearing chat notifications: $e');
    }
  }
}

/// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ background (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å top-level —Ñ—É–Ω–∫—Ü–∏–µ–π)
@pragma('vm:entry-point')
Future<void> _handleBackgroundMessage(RemoteMessage message) async {
  debugPrint('üì± Background message received: ${message.messageId}');

  // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ background
  // –ù–∞–ø—Ä–∏–º–µ—Ä, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
}
